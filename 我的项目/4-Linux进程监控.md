# Linux进程监控

Linux系统上监控进程启停的方式有几种。
* LD_PRELOAD：预加载模块注入。
* netlink：应用层和内核之间IPC通信，接收内核通知的进程监控。
* audit：利用系统审计功能进行进程监控。
* syscall hook：hook系统进程创建的api。

先说结论：推荐netlink。

## LD_PRELOAD
LD_PRELOAD是Linux系统的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入程序，从而达到特定的目的。

`/etc/ld.so.preload`配置文件和环境变量是同一个效果。

### preload监控原理
两点基础知识：
1. Linux 中大部分的可执行程序是动态链接的，常用的有关进程执行的函数例如`execve`均实现在 libc.so 这个动态链接库中。
2. Linux 提供了一个 ld preload 的机制，它允许定义优先加载的动态链接库，方便使用者有选择地载入不同动态链接库中的相同函数。

结合上述两点，我们可以通过 lf preload 来覆盖 libc.so 中的`execve`等函数来监控进程的创建。

### 优缺点
* 使用条件
  该方法没有什么条件限制，只需有 root 权限即可。
* 优点
  轻量级，只修改库函数代码，不与内核进行交互。
* 缺点
  1. 只影响preload之后创建的进程。一些系统初始化就运行的进程会监控不到。
  2. 无法监控静态链接的进程，此进程不需要加载动态库，因此，没有机会触发preload。
  3. 系统全局影响，范围太广，容易出问题。
  4. 很容易被检测并篡改。

## NET_LINK
