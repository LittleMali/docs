# Linux文件监控

在Linux系统中，Audit服务是一个用于监控系统活动并记录事件的工具。它可以帮助系统管理员追踪系统中发生的任何相关活动，以便在需要时进行审查或调查。

以下是Linux Audit服务可以审计的一些内容：
* 系统调用：Audit服务可以记录任何系统调用，包括谁发起了调用，调用何时发生，以及调用的结果是什么。
* 文件和目录的访问：Audit服务可以记录对特定文件或目录的所有访问，包括读取、写入和删除操作。
* 网络活动：Audit服务可以记录所有的网络活动，包括打开和关闭的网络连接，以及通过网络发送和接收的数据。
* 用户和组的更改：Audit服务可以记录所有关于用户和组的更改，包括添加、删除和修改用户或组，以及密码更改。
* 系统启动和关机：Audit服务可以记录系统的启动和关机时间，以及在这些时间内发生的任何活动。
* 身份验证和授权：Audit服务可以记录所有的身份验证和授权活动，包括登录、注销、sudo命令的使用，以及任何尝试绕过安全控制的活动。

audit是通过监控系统调用的方式来实现审计，进程创建，文件读写，网络连接等都有相关的系统调用，监控这些就可以拿到相关的信息。

## audit框架
![20240817163225](https://raw.githubusercontent.com/LittleMali/docs/master/mdPics/20240817163225.png)
实线箭头表示组件之间的数据流，虚线箭头表示组件之间的控制线。

audit 是内核中的一个模块，内核的运行情况都会记录在 audit 中，当然这个记录的规则是由超级用户来设置的。audit.rules 是 audit 的规则文件，auditctl程序负责将规则写入audit模块的过滤器中，过滤后的数据都会传送到 auditd 中，然后再由 auditd 进行其它操作。auditd.conf 是 auditd 的配置文件，确定 auditd 是如何启动的，日志文件放在哪里等等。auditd 收到的数据后会有两个去处。默认的是将日志保存在 audit.log 文件中，默认路径/var/log/audit/audit.log。另一个通过 audispd 将日志进行分发。

* auditd
审计守护程序负责将通过审计内核接口生成并由应用程序和系统活动触发的审计消息写入磁盘。审计守护程序的启动方式由 systemd 控制。审计系统功能（启动后）由 /etc/audit/auditd.conf 控制。
* auditctl
auditctl 实用程序可控制审计系统。它可控制审计接口的日志生成参数和内核设置，以及用于确定要跟踪哪些事件的规则集。
* 审计规则
/etc/audit/audit.rules 文件包含一系列 auditctl 命令，在系统引导时，启动审计守护程序后会紧接着装载这些命令。
* aureport
aureport 实用程序可让您基于审计事件日志创建自定义报告。您可以轻松编写生成报告的脚本，而各种其他应用程序可以使用脚本的输出来绘制这些结果的图表以及执行其他操作
* ausearch
ausearch 实用程序可以使用所记录的格式的各种键或其他特征在审计日志文件中搜索特定的事件。
* audispd
审计调度程序守护程序 (audispd) 可用于将事件通知中继到其他应用程序，而不是将其写入磁盘上的审计日志中（或除了执行此操作之外）。
* autrace
autrace 实用程序以类似于 strace 的方式跟踪单个进程。autrace 的输出将记录到审计日志。
* aulastlog
以类似于 lastlog 的方式列显所有计算机用户的上次登录信息。将列显登录名、端口和上次登录时间。

## audit源码
https://github.com/linux-audit/audit-userspace/blob/master/contrib/plugin/audisp-example.c

## auditctl使用
审计系统根据一组规则运行，这组规则定义了日志文件中所获取的内容。有三种类型的审核规则可以详细说明：

* 控制规则 — 允许审计系统的行为和它的一些被修改的配置。
* 文件系统规则 — 也被称为文件监视，允许审计进入特定文件或者目录。
* 系统调用规则 — 允许记录任何指定程序所做的系统调用。
* 
审核规则可以在命令行上使用 auditctl ，auditctl 命令控制审计系统的基本功能并且限定规则来决定哪些审计项目要记录。注意：
1. 所有与审计服务交互的命令以及审核日志文件都需要 root 权限。
2. 通过命令生成的规则，重启后会失效。保持永久生效需写入文件。

相关配置文件：
/etc/audit/auditd.conf : auditd工具的配置文件
/etc/audit/rules.d/audit.rules：包含审核规则的文件
/etc/audit/audit.rules : 记录审计规则的文件

## auditctl常用参数
通过auditctl向系统添加监控项，常见的命令行有：
* -w ：添加指定要监控的路径。
* -p ：指定触发审计的文件/目录的访问权限rwxa，r 读取权限，w 写入权限，x 执行权限，a 属性（attr）。
* -k：在审核规则上设置过滤名称，方便后面使用ausearch查找。
* -D：删除所有规则和监控。
* -W: 删除指定path的规则和-w对应，参数都要一样才能删除。

## auditspd使用
审计系统还允许外部应用程序实时访问和使用 auditd 守护程序。此功能由审计调度程序提供。audispd 是用于控制审计调度程序的守护程序。它通常由 auditd 启动。audispd 会提取审计事件并将其分发到想要对其进行实时分析的程序。auditd 的配置储存在 /etc/audisp/audispd.conf 中。
