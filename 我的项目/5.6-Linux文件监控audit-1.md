# Linux文件监控audit-1

audit是系统调用的审计，利用audit实现文件监控实际是监控特定api的调用，比如open，rename等。因此，我们想要监控文件操作就需要识别出某个文件操作对应的是什么api。但是，Linux系统的文件操作实际是一系列系统调用（open、read、write、close...）的组合。

例如，要拷贝一个文件，可能需要使用 open 系统调用打开源文件和目标文件，使用 read 系统调用读取源文件的内容，使用 write 系统调用将内容写入目标文件，然后使用 close 系统调用关闭两个文件。这些操作通常会被封装在一个函数中，例如 C 标准库的 fread 和 fwrite 函数，或者更高级的库函数，例如 GLib 的 g_file_copy 函数。

所以，在Windows上的CopyFile和MoveFile这类操作，在Linux上其实找不到直接的系统调用可以一一对应。

所以，单靠audit来实现文件监控是比较麻烦的，但是，fanotify可以准确区分`文件创建，读取，写关闭，读关闭`这几个场景。但是，对于`文件重命名、文件移动、拷贝，删除`这几个场景，仅涉及有限的系统调用，这几个场景使用audit更合适。


09-23：
应该说，fanotify比较好用，结构清晰，易于解析实现。但是，在Linux上shell操作是个很高频的行为，对于部分shell操作mv，cp，rm等，fanotify监控不到，此时，引入audit更加合适。我们只关心几个有限的场景。

```
======================create======================
2	open
83	mkdir
85	creat
86	link
88	symlink
165	mount
257	openat
258	mkdirat
259	mknodat
133	mknod
265	linkat
266	symlinkat
304	open_by_handle_at
```

```c
// 文件监控
enum class EFileEvent : int {
    None = 0,

    // fanotify
    Create = 0x01, // FAN_CLOSE_WRITE
    Read = 0x20, // FAN_ACCESS
    WriteClose = 0x40, // FAN_CLOSE_WRITE
    ReadClose = 0x80, // FAN_CLOSE_NOWRITE

    // audit
    Delete = 0x02, // -S unlink rmdir unmount2 unlikat
    Rename = 0x04, // -S rename renameat renameat2
    Move = 0x08, // same as Rename
    Copy = 0x10,  // -S tee dup dup2 dup3 copy_file_range
};
```

使用cp命令的结果：
{"cwd":"/home/semonma/桌面/audit-test/create-test/dir","key":"ioa_file_read","objpid":null,"paths":[{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186175","item":"0","mode":"file,664","name":"hh.txt","nametype":"NORMAL","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"}],"proctitle":{"node":"semonma","proctitle":"cp hh.txt cc.txt","type":"PROCTITLE"},"sockaddr":null,"syscall":{"a0":"AT_FDCWD","a1":"0x7fffa04931d4","a2":"O_RDONLY","a3":"0x0","arch":"x86_64","auid":"semonma","comm":"cp","egid":"semonma","euid":"semonma","exe":"/usr/bin/cp","exit":"3","fsgid":"semonma","fsuid":"semonma","gid":"semonma","items":"1","key":"ioa_file_read","node":"semonma","pid":"183340","ppid":"10356","ses":"2","sgid":"semonma","subj":"?","success":"yes","suid":"semonma","syscall":"openat","tty":"pts1","type":"SYSCALL","uid":"semonma"}}

{"cwd":"/home/semonma/桌面/audit-test/create-test/dir","key":"ioa_file_create","objpid":null,"paths":[{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186176","item":"0","mode":"file,664","name":"cc.txt","nametype":"NORMAL","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"}],"proctitle":{"node":"semonma","proctitle":"cp hh.txt cc.txt","type":"PROCTITLE"},"sockaddr":null,"syscall":{"a0":"AT_FDCWD","a1":"0x7fffa04931db","a2":"O_WRONLY|O_TRUNC","a3":"0x0","arch":"x86_64","auid":"semonma","comm":"cp","egid":"semonma","euid":"semonma","exe":"/usr/bin/cp","exit":"4","fsgid":"semonma","fsuid":"semonma","gid":"semonma","items":"1","key":"ioa_file_create","node":"semonma","pid":"183340","ppid":"10356","ses":"2","sgid":"semonma","subj":"?","success":"yes","suid":"semonma","syscall":"openat","tty":"pts1","type":"SYSCALL","uid":"semonma"}}

同时，fanotify的打印记录：
Received event in path: /home/semonma/桌面/audit-test/create-test/dir/hh.txt, pid: 138, mask: FAN_OPEN |
Received event in path: /home/semonma/桌面/audit-test/create-test/dir/cc.txt, pid: 138, mask: FAN_OPEN |
Received event in path: /home/semonma/桌面/audit-test/create-test/dir/cc.txt, pid: 138, mask: FAN_MODIFY |FAN_CLOSE_WRITE |
Received event in path: /home/semonma/桌面/audit-test/create-test/dir/hh.txt, pid: 137, mask: FAN_ACCESS |FAN_CLOSE_NOWRITE




使用mv命令的结果：
{"cwd":"/home/semonma/桌面/audit-test/create-test/dir","key":"ioa_file_rename","objpid":null,"paths":[{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186172","item":"0","mode":"dir,775","name":"/home/semonma/桌面/audit-test/create-test/dir","nametype":"PARENT","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"},{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186172","item":"1","mode":"dir,775","name":"/home/semonma/桌面/audit-test/create-test/dir","nametype":"PARENT","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"},{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186175","item":"2","mode":"file,664","name":"hh.txt","nametype":"DELETE","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"},{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186175","item":"3","mode":"file,664","name":"mm.txt","nametype":"CREATE","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"}],"proctitle":{"node":"semonma","proctitle":"mv hh.txt mm.txt","type":"PROCTITLE"},"sockaddr":null,"syscall":{"a0":"AT_FDCWD","a1":"0x7fff8915f1d4","a2":"AT_FDCWD","a3":"0x7fff8915f1db","arch":"x86_64","auid":"semonma","comm":"mv","egid":"semonma","euid":"semonma","exe":"/usr/bin/mv","exit":"0","fsgid":"semonma","fsuid":"semonma","gid":"semonma","items":"4","key":"ioa_file_rename","node":"semonma","pid":"183651","ppid":"10356","ses":"2","sgid":"semonma","subj":"?","success":"yes","suid":"semonma","syscall":"renameat2","tty":"pts1","type":"SYSCALL","uid":"semonma"}}

同时，fanotify的记录：
没监控到。。。




使用rm -f mm.txt的结果：
{"cwd":"/home/semonma/桌面/audit-test/create-test/dir","key":"ioa_file_delete","objpid":null,"paths":[{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186172","item":"0","mode":"dir,775","name":"/home/semonma/桌面/audit-test/create-test/dir","nametype":"PARENT","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"},{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186175","item":"1","mode":"file,664","name":"mm.txt","nametype":"DELETE","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"}],"proctitle":{"node":"semonma","proctitle":"rm -f mm.txt","type":"PROCTITLE"},"sockaddr":null,"syscall":{"a0":"AT_FDCWD","a1":"0x562967a114e0","a2":"0x0","a3":"0x0","arch":"x86_64","auid":"semonma","comm":"rm","egid":"semonma","euid":"semonma","exe":"/usr/bin/rm","exit":"0","fsgid":"semonma","fsuid":"semonma","gid":"semonma","items":"2","key":"ioa_file_delete","node":"semonma","pid":"183685","ppid":"10356","ses":"2","sgid":"semonma","subj":"?","success":"yes","suid":"semonma","syscall":"unlinkat","tty":"pts1","type":"SYSCALL","uid":"semonma"}}

同时，fanotify结果：
没监控到。。。



使用桌面系统自带的 文本编辑器打开 pp.txt，编辑并保存时：
audit打印了很多记录，例如如下。由于文本编辑器也会生成中间缓存文件，类似vim，所以，涉及的操作很多，下面有一条rename记录。
{"cwd":"/home/semonma","key":"ioa_file_rename","objpid":null,"paths":[{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186168","item":"0","mode":"dir,775","name":"/home/semonma/桌面/audit-test/create-test/","nametype":"PARENT","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"},{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186168","item":"1","mode":"dir,775","name":"/home/semonma/桌面/audit-test/create-test/","nametype":"PARENT","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"},{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1181236","item":"2","mode":"file,664","name":"/home/semonma/桌面/audit-test/create-test/.goutputstream-0W4XU2","nametype":"DELETE","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"},{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186171","item":"3","mode":"file,664","name":"/home/semonma/桌面/audit-test/create-test/pp.txt","nametype":"DELETE","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"},{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1181236","item":"4","mode":"file,664","name":"/home/semonma/桌面/audit-test/create-test/pp.txt","nametype":"CREATE","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"}],"proctitle":{"node":"semonma","proctitle":"pluma /home/semonma/桌面/audit-test/create-test/pp.txt","type":"PROCTITLE"},"sockaddr":null,"syscall":{"a0":"0x55b17dc25310","a1":"0x7f23400021c0","a2":"0x7f2347732b30","a3":"0x1","arch":"x86_64","auid":"semonma","comm":"pool-pluma","egid":"semonma","euid":"semonma","exe":"/usr/bin/pluma","exit":"0","fsgid":"semonma","fsuid":"semonma","gid":"semonma","items":"5","key":"ioa_file_rename","node":"semonma","pid":"183888","ppid":"1","ses":"2","sgid":"semonma","subj":"?","success":"yes","suid":"semonma","syscall":"rename","tty":"(none)","type":"SYSCALL","uid":"semonma"}}

{"cwd":"/home/semonma","key":"ioa_file_read","objpid":null,"paths":[{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1186168","item":"0","mode":"dir,775","name":"/home/semonma/桌面/audit-test/create-test","nametype":"NORMAL","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"}],"proctitle":{"node":"semonma","proctitle":"/usr/bin/peony","type":"PROCTITLE"},"sockaddr":null,"syscall":{"a0":"0x7fb02c002880","a1":"W_OK","a2":"0x400000","a3":"0x7fb02c003f58","arch":"x86_64","auid":"semonma","comm":"pool","egid":"semonma","euid":"semonma","exe":"/usr/bin/peony","exit":"0","fsgid":"semonma","fsuid":"semonma","gid":"semonma","items":"1","key":"ioa_file_read","node":"semonma","pid":"183740","ppid":"1","ses":"2","sgid":"semonma","subj":"?","success":"yes","suid":"semonma","syscall":"access","tty":"(none)","type":"SYSCALL","uid":"semonma"}}

{"cwd":"/home/semonma","key":"ioa_file_read","objpid":null,"paths":[{"cap_fe":"0","cap_fi":"none","cap_fp":"none","cap_frootid":"0","cap_fver":"0","dev":"08:07","inode":"1181236","item":"0","mode":"file,664","name":"/home/semonma/桌面/audit-test/create-test/pp.txt","nametype":"NORMAL","node":"semonma","ogid":"semonma","ouid":"semonma","rdev":"00:00","type":"PATH"}],"proctitle":{"node":"semonma","proctitle":"/usr/bin/peony","type":"PROCTITLE"},"sockaddr":null,"syscall":{"a0":"0x55bc87631a70","a1":"R_OK","a2":"0x400000","a3":"0x11","arch":"x86_64","auid":"semonma","comm":"pool","egid":"semonma","euid":"semonma","exe":"/usr/bin/peony","exit":"0","fsgid":"semonma","fsuid":"semonma","gid":"semonma","items":"1","key":"ioa_file_read","node":"semonma","pid":"183740","ppid":"1","ses":"2","sgid":"semonma","subj":"?","success":"yes","suid":"semonma","syscall":"access","tty":"(none)","type":"SYSCALL","uid":"semonma"}}


同时，fanotify的结果：
Received event in path: /home/semonma/桌面/audit-test/create-test/pp.txt, pid: 50, mask: FAN_OPEN |
Received event in path: /home/semonma/桌面/audit-test/create-test/pp.txt, pid: 50, mask: FAN_ACCESS |
Received event in path: /home/semonma/桌面/audit-test/create-test/pp.txt, pid: 50, mask: FAN_CLOSE_NOWRITE
Received event in path: /home/semonma/桌面/audit-test/create-test/pp.txt, pid: 50, mask: FAN_OPEN |FAN_CLOSE_WRITE |
Received event in path: /home/semonma/桌面/audit-test/create-test/.goutputstream-XAL0U2, pid: 56, mask: FAN_OPEN |
Received event in path: /home/semonma/桌面/audit-test/create-test/.goutputstream-XAL0U2, pid: 50, mask: FAN_OPEN |FAN_MODIFY |
Received event in path: /home/semonma/桌面/audit-test/create-test/.goutputstream-XAL0U2, pid: 50, mask: FAN_ACCESS |FAN_CLOSE_NOWRITE
Received event in path: /home/semonma/桌面/audit-test/create-test/pp.txt, pid: 50, mask: FAN_CLOSE_WRITE |
