# 远程中断

## 问题
用户反馈，远程大概率直接失败，远程窗口闪一下就弹出“远程已断开”。或者就是远程一会以后会断开。

## 解决
问题的定位是分步走的，先看日志，再抓包，一般不会直接上抓包这种利器。
先理一下架构，主exe拉起工作exe和代理exe开始远程协助。
主exe ---[run]--- 工作exe <---[127.0.0.1]---> 代理exe <---[ip:port]--> 后台。
### 初步分析
1. 远程建立以后，窗口闪一下就退出了，然后主exe提示了“远程已断开”。
2. 分析日志，“远程已断开”这个提示是判断到代理exe退出，但是代理exe为什么会退出？
3. 看代理exe的日志，有几次退出是因为后台回复了失败，但是更多的日志显示后台应答是成功的。
4. 原本以为是代理exe跟后台握手协商的时候失败了，因此引起了退出，现在来看不是这样。
5. 除了代理exe以后，还有工作exe的日志可以分析。
6. 工作exe的日志显示网络通信断了，这个错误码提示“对端发起了rst”。工作exe是与代理exe建立了本地127的tcp连接，对端发起了rst，那就是代理exe拒绝了工作exe。
   
### 进一步分析
1. 远程协助涉及多个进程的网络通信，那么，是否是网络通信断了，导致进程退出？
2. 代理exe为什么发起rst？先wireshark抓个包看看，是否真的发起了rst。
3. wireshark抓包分析，代理exe与后台建立tcp连接成功，过了一会，代理exe发起了rst，中断了链路。
4. wireshark相当于实锤了是客户端的问题，客户端要继续看了。
5. 客户端发起了rst，是否是哪个socket处理的有问题，走到异常分支close了？在close socket的地方加日志，看看是否有问题。
6. 看日志，竟然没有发现调用close的地方，再继续加，代理exe继续加日志，代理exe与后台connect连接的地方，代理exe本地127 tcp srv的地方加日志。最后，还是很奇怪，几乎看不到close socket的地方。
7. procmon来协助一下，过滤进程，追踪网络活动和进程活动，发现客户端确实rst了，然后进程退出了。
8. 窗口闪一下就没了，难道是crash了？但是又没有dmp生成。噢，此独立进程代理exe压根就没接bugreport。

### 分析dmp
1. 代理exe接入bugreport，在远程已断开的时候，生成了一个dmp。
2. 看dmp异常栈，是调用函数的时候传入的指针不对。难道是指针内存被破坏了？
3. 对该指针的操作，是否有多线程问题？没有多线程，只是单线程操作。
4. 指针被释放了？尴尬的是这段代码根本没有显示释放指针的地方。